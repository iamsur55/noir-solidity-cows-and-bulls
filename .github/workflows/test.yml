name: cows_and_bulls_ci

permissions: {}

on:
  push:
  pull_request:
  workflow_dispatch:

env:
  FOUNDRY_VERSION: v1.5.1
  NARGO_VERSION: 1.0.0-beta.18
  BB_VERSION: 3.0.0-nightly.20260102
  ARCH: linux_amd64

jobs:
  check:
    name: cows-and-bulls
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          persist-credentials: false
          submodules: recursive

      - name: Install Foundry (CI-stable binary)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "Installing Foundry $FOUNDRY_VERSION"

          # Fetch the GitHub release asset for the chosen version
          API_JSON=$(curl -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/foundry-rs/foundry/releases/tags/${FOUNDRY_VERSION})

          ASSET_URL=$(printf '%s' "$API_JSON" | jq -r ".assets[]? | select(.name==\"foundry_${FOUNDRY_VERSION#v}_${ARCH}.tar.gz\") | .browser_download_url")

          if [[ -z "$ASSET_URL" ]]; then
            echo "GitHub API response did not contain expected asset."
            printf '%s\n' "$API_JSON" | jq -r '.message? // "(no API error message)"'
            echo "ERROR: Could not find download URL for Foundry $FOUNDRY_VERSION"
            exit 1
          fi

          # Download and verify gzip archive
          curl -L --retry 5 --retry-delay 2 "$ASSET_URL" -o foundry.tar.gz
          file foundry.tar.gz | grep -q 'gzip' || { echo "ERROR: Not a gzip archive"; exit 1; }

          # Extract and install
          tar -xzf foundry.tar.gz
          mkdir -p "$HOME/.foundry/bin"
          mv forge cast anvil chisel "$HOME/.foundry/bin"
          echo "$HOME/.foundry/bin" >> "$GITHUB_PATH"

          # Verify binaries
          forge --version
          anvil --version

      - name: Install Noir
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://raw.githubusercontent.com/noir-lang/noirup/refs/heads/main/install | bash
          "$HOME/.nargo/bin/noirup" -v "$NARGO_VERSION"
          echo "$HOME/.nargo/bin" >> "$GITHUB_PATH"
          nargo --version

      - name: Install Barretenberg
        shell: bash
        run: |
          set -euo pipefail
          curl -L https://raw.githubusercontent.com/AztecProtocol/aztec-packages/refs/heads/next/barretenberg/bbup/install | bash
          "$HOME/.bb/bbup" -v "$BB_VERSION"
          echo "$HOME/.bb" >> "$GITHUB_PATH"
          bb --version

      - name: Run circuit checks
        run: npm run zk:check

      - name: Prepare prover inputs
        run: cp circuits/Prover.example.toml circuits/Prover.toml

      - name: Execute circuit
        run: npm run zk:execute

      - name: Generate verifier
        run: npm run zk:verifier

      - name: Generate proof
        run: npm run zk:proof

      - name: Run Forge fmt
        run: forge fmt --check

      - name: Run Forge build
        run: forge build --sizes

      - name: Run Foundry tests
        run: npm run foundry:test